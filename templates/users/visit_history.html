{% extends "users/base.html" %}
{% load static %}

{% block content %}
{% include "users/sidebar.html" %}
<div class="main-panel">
  <div class="main-header">
    <div class="main-header-logo">
      <div class="logo-header" data-background-color="dark">
        <a href="index.html" class="logo">
          <img src="{% static 'assets/img/kaiadmin/logo_light.svg' %}" alt="navbar brand" class="navbar-brand" height="20" />
        </a>
        <div class="nav-toggle">
          <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
          <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
        </div>
        <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
      </div>
    </div>
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">
      <h3 class="mb-4">
        <i class="bi bi-clock-history me-2"></i> Visit History for <span style="font-weight: 900; color: blueviolet;">{{ company }}</span>
      </h3>

      <!-- Visit History List -->
      <div class="list-group list-group-flush">
        {% for update in stage_updates %}
          <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center py-2 border-bottom">
            <div>
              <h6 class="mb-1">
                <i class="bi bi-flag me-1"></i> <strong>{{ update.meeting_stage }}</strong>
              </h6>
              <small>
                {% if update.contract_outcome %}
                  <span class="badge 
                    {% if update.contract_outcome == 'Won' %}bg-success
                    {% elif update.contract_outcome == 'Lost' %}bg-danger
                    {% elif update.contract_outcome == 'Pending' %}bg-warning text-dark
                    {% else %}bg-secondary text-dark{% endif %}">
                    <i class="bi bi-check2-circle me-1"></i> Outcome: {{ update.contract_outcome }}
                  </span>
                {% endif %}
                {% if update.is_payment_collected %}
                  <span class="badge bg-info text-dark ms-1">
                    <i class="bi bi-cash-coin me-1"></i>Is Payment collected: {{ update.is_payment_collected }}
                  </span>
                {% endif %}
                {% if update.status %}
                  <span class="badge 
                    {% if update.status == 'Open' %}bg-primary
                    {% elif update.status == 'Won Paid' %}bg-success
                    {% elif update.status == 'Won Pending Payment' %}bg-warning text-dark
                    {% elif update.status == 'Lost' %}bg-danger
                    {% else %}bg-secondary text-dark{% endif %} ms-1">
                    <i class="bi bi-info-circle me-1"></i> Status: {{ update.status }}
                  </span>
                {% endif %}
              </small>
              <br>
              <small class="text-muted">
                <i class="bi bi-person-circle me-1"></i> Updated by {{ update.updated_by }} 
                <i class="bi bi-clock me-1 ms-2"></i> {{ update.updated_at }}
              </small>
            </div>
            <div class="mt-2 mt-md-0">
              <a href="{% url 'visit_stage_detail' update.id %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye me-1"></i> View Details
              </a>
            </div>
          </div>
        {% empty %}
          <div class="list-group-item text-muted border-bottom">
            <i class="bi bi-exclamation-circle me-1"></i> No updates recorded for this visit yet.
          </div>
        {% endfor %}
      </div>

    </div>
  </div>
</div>

<!-- Include Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
  .list-group-item {
    background-color: transparent; /* keep flat */
    padding-left: 0;
    padding-right: 0;
  }
  .border-bottom {
    border-bottom: 1px solid #dee2e6; /* subtle divider */
  }
  .mb-4 { margin-bottom: 1.5rem; }
  .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
  .mt-2 { margin-top: 0.5rem; }
</style>

{% endblock %}
